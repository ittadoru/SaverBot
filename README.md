# BotTemplate (Telegram Bot + FastAPI + PostgreSQL + YooKassa)

–ü—Ä–æ–µ–∫—Ç ‚Äî –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π —à–∞–±–ª–æ–Ω: Telegram‚Äë–±–æ—Ç (aiogram 3) + FastAPI –≤–µ–±‚Äë—Å–µ—Ä–≤–µ—Ä (webhook/payment endpoint) + PostgreSQL (SQLAlchemy 2 async + Alembic) + YooKassa –ø–ª–∞—Ç–µ–∂–∏. –¶–µ–ª—å: –±—ã—Å—Ç—Ä–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏ –∞–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å—é, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å –∫–æ–¥–∞.

–í–∞–∂–Ω–æ: —Ñ–∞–π–ª `.env` –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä `.env.example` –∏ –Ω–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã / –∫–ª—é—á–∏.

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –º–µ–Ω—é, –ø–æ–¥–ø–∏—Å–∫–∞, –ø—Ä–æ–º–æ–∫–æ–¥—ã
* –ê–¥–º–∏–Ω‚Äë—Ä–∞–∑–¥–µ–ª: —Ä–∞—Å—Å—ã–ª–∫–∏ (3 —Ç–∏–ø–∞), —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —ç–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏ + –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
* –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ YooKassa (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ + –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook `/yookassa`)
* –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î Alembic (async URL ‚Üí sync –¥–ª—è –º–∏–≥—Ä–∞—Ç–æ—Ä–∞)
* –ü–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–æ–≤–∞–Ω–æ (Docker Compose)
* –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `requirements.txt` —Ç–æ–ª—å–∫–æ —Å –ø—Ä—è–º—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (–≤–∞—Ä–∏–∞–Ω—Ç –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π)
–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –ù–ï–¢ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π –≤ `alembic/versions/` (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞), —á—Ç–æ–±—ã –Ω–µ —Ç–∞—â–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π. –°—Ö–µ–º—É –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

```bash
git clone https://github.com/ittadoru/BotTemplate.git
cd BotTemplate
cp .env.example .env        # –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è
docker compose up -d --build
docker compose logs -f app  # —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
```
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –æ–¥–Ω–æ –∏–∑:
* –ï—Å—Ç—å —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π -> `alembic upgrade head`
* –ù–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–π -> `scripts/ensure_schema.py` —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã –Ω–∞–ø—Ä—è–º—É—é
–î–∞–ª—å—à–µ:
* –ë–æ—Ç: –æ—Ç–∫—Ä—ã—Ç—å –≤ Telegram (–ø–æ —Ç–æ–∫–µ–Ω—É BOT_TOKEN)
* Webhook –æ–ø–ª–∞—Ç (YooKassa): `https://DOMAIN/yookassa` (DOMAIN –≤ `.env`)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic (baseline):
```bash
docker compose exec app alembic revision --autogenerate -m "baseline"
# –æ—Ç–∫—Ä—ã—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ alembic/versions/, –£–ë–ï–î–ò–¢–¨–°–Ø —á—Ç–æ down_revision = None
docker compose exec app alembic upgrade head
```
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª baseline –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å (–µ—Å–ª–∏ —É–∂–µ –Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è), –∞ –ø—Ä–∞–≤–∏–ª–æ –≤ `.gitignore` –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —É–±—Ä–∞—Ç—å.

---

## üìã –ü–æ–ª–Ω–∞—è –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–±–µ–∑ –≥–æ—Ç–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π)
1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
2. –°–æ–∑–¥–∞—Ç—å `.env` –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ (`cp .env.example .env`).
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—Å–º. —Ç–∞–±–ª–∏—Ü—É –Ω–∏–∂–µ).
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: `docker compose up -d --build`.
5. –î–æ–∂–¥–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã (–ª–∏–±–æ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏, –ª–∏–±–æ ensure_schema). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `docker compose logs -f app`.
6. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –ª–∏—á–Ω–æ—Å –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa ‚Üí URL: `https://DOMAIN/yookassa`.
7. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (YooKassa sandbox) ‚Üí —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏.
8. –ì–æ—Ç–æ–≤–æ.

–ï—Å–ª–∏ –ø–æ–∑–∂–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å: `docker compose exec app alembic revision --autogenerate -m "baseline"`
2. –û—Ç–∫—Ä—ã—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ `alembic/versions/`, –≤—Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `down_revision = None` (–µ—Å–ª–∏ –Ω–µ —Ç–∞–∫).
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å: `docker compose exec app alembic upgrade head`
4. –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∏–≥–Ω–æ—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π –∏–∑ `.gitignore` (–ª–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –µ—Å–ª–∏ baseline –ø—Ä–∏–≤–∞—Ç–Ω—ã–π).
5. –ö–æ–º–º–∏—Ç–Ω—É—Ç—å baseline –∏ –¥–∞–ª—å—à–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–≤–∏–∑–∏–∏ –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.

---

## üîê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ `.env.example`.
| –ò–º—è | –û–±—è–∑–∞—Ç. | –ü—Ä–∏–º–µ—Ä | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----|---------|--------|-----------|
| BOT_TOKEN | –î–∞ | 123456:ABC | –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ |
| ADMINS | –ù–µ—Ç | 111,222 | –°–ø–∏—Å–æ–∫ ID –∞–¥–º–∏–Ω–æ–≤ |
| ADMIN | –î–∞ | 111 | –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫) |
| DATABASE_URL | –î–∞ | postgresql+asyncpg://user:pass@postgres:5432/appdb | Async URL –ë–î |
| POSTGRES_USER | –î–∞ | appuser | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Postgres –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —á–∞—Å—Ç—å—é DATABASE_URL) |
| POSTGRES_PASSWORD | –î–∞ | strongpass | –ü–∞—Ä–æ–ª—å Postgres –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å DATABASE_URL) |
| POSTGRES_DB | –î–∞ | appdb | –ò–º—è –ë–î (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å DATABASE_URL) |
| SHOP_ID | –î–∞ | 123456 | YooKassa shop id |
| API_KEY | –î–∞ | test_xxx | YooKassa secret key |
| DOMAIN | –î–∞ | https://mydomain.ru | –ë–∞–∑–æ–≤—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ–º–µ–Ω –¥–ª—è webhook |
| SUPPORT_GROUP_ID | –ù–µ—Ç | -100123456789 | –ì—Ä—É–ø–ø–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ |
| SUBSCRIBE_TOPIC_ID | –ù–µ—Ç | 12 | ID —Ç–æ–ø–∏–∫–∞ (—Ñ–æ—Ä—É–º) |

---

## üóÑ –ú–∏–≥—Ä–∞—Ü–∏–∏ Alembic (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ë–ï–ó —Ñ–∞–π–ª–æ–≤ —Ä–µ–≤–∏–∑–∏–π (`alembic/versions/` –ø—É—Å—Ç). –°—Ö–µ–º–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `scripts/ensure_schema.py`.

–ö–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π —Å—Ö–µ–º—ã:
1. –£–¥–∞–ª–∏—Ç–µ (–∏–ª–∏ –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ) –ª–∏—à–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ ‚Äî –∂–µ–ª–∞–µ–º—ã–π baseline.
2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ baseline —Ä–µ–≤–∏–∑–∏—é:
	```bash
	docker compose exec app alembic revision --autogenerate -m "baseline"
	```
3. –í —Ñ–∞–π–ª–µ baseline —É–±–µ–¥–∏—Ç–µ—Å—å `down_revision = None`.
4. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞ —á–∏—Å—Ç–æ–π –ë–î): `docker compose exec app alembic upgrade head`.
5. –£–±–µ—Ä–∏—Ç–µ –∏–≥–Ω–æ—Ä `alembic/versions/*.py` –∏–∑ `.gitignore` –∏ –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ baseline.
6. –î–∞–ª–µ–µ —Ü–∏–∫–ª:
	```bash
	docker compose exec app alembic revision --autogenerate -m "change"
	docker compose exec app alembic upgrade head
	```
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
* –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ diff –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º.
* –ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ.

### üü° –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π (–¥–ª—è —à–∞—Ä–∏–Ω–≥–∞ –¥—Ä—É–≥—É)
–ï—Å–ª–∏ —Ç—ã –ù–ï —Ö–æ—á–µ—à—å –≤—ã–∫–ª–∞–¥—ã–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π –≤ Git –∏ –Ω—É–∂–µ–Ω –ø—Ä–æ—Å—Ç–æ ¬´—á–∏—Å—Ç—ã–π¬ª —Å—Ç–∞—Ä—Ç:

1. –£–¥–∞–ª–∏ (–∏–ª–∏ –Ω–µ –∫–æ–º–º–∏—Ç—å) –ø–∞–ø–∫—É `alembic/versions/*`.
2. –î—Ä—É–≥ –∫–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç (–æ–¥–∏–Ω —Ä–∞–∑) –ø–æ—Å–ª–µ –ø–æ–¥–Ω—è—Ç–∏—è:
	 ```bash
	 docker compose exec app python scripts/ensure_schema.py
	 ```
4. –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `Base.metadata.create_all()` –µ—Å–ª–∏ –Ω–µ—Ç `alembic_version`.

–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –∏ —Ç.–ø.) —ç—Ç–∏–º —Å–ø–æ—Å–æ–±–æ–º –ù–ï –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –Ω—É–∂–Ω–æ –ª–∏–±–æ:
* –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ Alembic (–¥–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ `alembic_version` –ø–æ—è–≤–∏—Ç—Å—è), –ª–∏–±–æ
* —Å–Ω–µ—Å—Ç–∏ volume –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å—ë –∑–∞–Ω–æ–≤–æ (–¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è):
	```bash
	docker compose down -v && docker compose up -d && docker compose exec app python scripts/ensure_schema.py
	```

–ö–æ–≥–¥–∞ —Å–æ–∑—Ä–µ–µ—Ç–µ –¥–ª—è ¬´–Ω–∞—Å—Ç–æ—è—â–∏—Ö¬ª –º–∏–≥—Ä–∞—Ü–∏–π:
1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–ø–∫—É `alembic/`.
2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ baseline (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ–≤–∏–∑–∏—é) —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π: `alembic revision --autogenerate -m "baseline"` –∏ –≤—Ä—É—á–Ω—É—é –ø–æ—Å—Ç–∞–≤—å—Ç–µ `down_revision = None`.
3. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ baseline –∏ –Ω–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.

---

## üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –†–æ–ª—å |
|-----------|------|
| `bot.py` | Aiogram –±–æ—Ç (polling) |
| `server.py` | FastAPI —Å–µ—Ä–≤–µ—Ä (webhook) |
| `utils/payment.py` | –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π YooKassa |
| `utils/webhook.py` | –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ |
| `db/` | –ú–æ–¥–µ–ª–∏ –∏ CRUD |
| `handlers/` | –†–æ—É—Ç–µ—Ä—ã (user/admin/support) |
| `services/` | –ë–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∞/—Å—Ü–µ–Ω–∞—Ä–∏–∏ (—è–¥—Ä–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è; —Å—é–¥–∞ –≤—ã–Ω–æ—Å–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É, —Ä–∞—Å—á—ë—Ç—ã, —Ä–∞—Å—Å—ã–ª–∫–∏) |
| `db/channels.py` | –ú–æ–¥–µ–ª—å –∫–∞–Ω–∞–ª–æ–≤ –∏ —Ñ–∏—á–∞‚Äë—Ñ–ª–∞–≥ (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ) |
| `alembic/` | –ú–∏–≥—Ä–∞—Ü–∏–∏ |

–ü–æ—Ç–æ–∫ –ø–ª–∞—Ç–µ–∂–∞: –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ ‚Üí –ø–ª–∞—Ç—ë–∂ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ ‚Üí webhook ‚Üí –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏.

–ü–∞–ø–∫–∞ `services/` ‚Äî –º–µ—Å—Ç–æ –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π –ª–æ–≥–∏–∫–∏ (–æ—Ä–∏–≥–∏–Ω–∞–ª —à–∞–±–ª–æ–Ω–∞ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç –≤—ã–Ω–æ—Å ¬´—É–º–Ω—ã—Ö¬ª –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤). –•–µ–Ω–¥–ª–µ—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–Ω–∫–∏–º–∏: –¥–æ—Å—Ç–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–ø–¥–µ–π—Ç–∞, –≤—ã–∑—ã–≤–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ `services/`, –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –æ—Ç–≤–µ—Ç—ã.

---

## üí≥ –ü–ª–∞—Ç–µ–∂–∏ / Webhook
* Endpoint: `POST /yookassa`
* Idempotency: persistent (—Ç–∞–±–ª–∏—Ü–∞ `processed_payments` + —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `payment_id`)

–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç idempotency:
1. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å `object.id` –ø–ª–∞—Ç–µ–∂–∞
2. –ü–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `SELECT` –ø–æ `processed_payments`
3. –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –µ—Å—Ç—å ‚Üí webhook –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–¥—É–±–ª–∏–∫–∞—Ç)
4. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è `payment_id`
5. –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≥–æ–Ω–∫—É –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

–¢–µ—Å—Ç:
1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ
2. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂
3. –°–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ webhook 2 —Ä–∞–∑–∞ ‚Äî –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –æ–¥–∏–Ω —Ä–∞–∑

---

## üì¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã / –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞
–§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏: —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –Ω–∞–±–æ—Ä –∫–∞–Ω–∞–ª–æ–≤, –µ—Å–ª–∏ —É –Ω–µ–≥–æ –ù–ï–¢ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
* –¢–∞–±–ª–∏—Ü–∞ `channels`: `username`, `chat_id`, `is_required`, `active`.
* –¢–∞–±–ª–∏—Ü–∞ `feature_flags`: –∫–ª—é—á `channel_guard` (–≤–∫–ª/–≤—ã–∫–ª –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).
* –ê–¥–º–∏–Ω‚Äë–º–µ–Ω—é: –∫–Ω–æ–ø–∫–∞ "ÔøΩ –ö–∞–Ω–∞–ª—ã" ‚Äî CRUD (–¥–æ–±–∞–≤–∏—Ç—å / —É–¥–∞–ª–∏—Ç—å / –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) + –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å üåê.

–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ê–¥–º–∏–Ω –≤–∫–ª—é—á–∞–µ—Ç üåê (`channel_guard`=ON).
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞—â–∏—â—ë–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä –º–µ–Ω—é –ø–æ–¥–ø–∏—Å–∫–∏ / –ª—é–±—É—é –∫–ª—é—á–µ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é).
3. –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–Ω–∞–ª, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω ‚Äî –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–±—É–µ–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ.
4. –ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç "üîÅ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞" (—Ä–µ‚Äë—á–µ–∫ —á–µ—Ä–µ–∑ `get_chat_member`).

–ì–¥–µ –≤–Ω–µ–¥—Ä—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å —Ö–µ–Ω–¥–ª–µ—Ä—ã –≤—ã–∑–æ–≤–æ–º guard (–ø—Ä–∏–º–µ—Ä —Å–º. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ –∏–ª–∏ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä/ middleware).

–£–¥–∞–ª–µ–Ω–∏–µ/–ø—Ä–∞–≤–∫–∞ –∫–∞–Ω–∞–ª–æ–≤: —á–µ—Ä–µ–∑ —ç–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É —Å—Ä–∞–∑—É.

–í–∞–∂–Ω–æ:
* –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö/–∑–∞–∫—Ä—ã—Ç—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –Ω—É–∂–µ–Ω `chat_id` –∏ –±–æ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞.
* –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –¥–µ—Ä–∂–∞—Ç—å ‚â§ 5 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ (—Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ API Telegram).
* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ üåê –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–Ω–∏–º–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ.

---

## ÔøΩ –¢–∏–ø—ã —Ä–∞—Å—Å—ã–ª–æ–∫

–í—Å–µ–≥–æ 3 —Å—Ü–µ–Ω–∞—Ä–∏—è (–∫–Ω–æ–ø–∫–∏ –≤ –∞–¥–º–∏–Ω‚Äë–º–µ–Ω—é –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ):

1. –û–±—ã—á–Ω–∞—è ‚Äî –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (`users`).
2. –†–µ–∫–ª–∞–º–Ω–∞—è ‚Äî —Ç–µ–º, —É –∫–æ–≥–æ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–Ω–æ –º–æ–≥–ª–∏ –ø–ª–∞—Ç–∏—Ç—å —Ä–∞–Ω—å—à–µ –∏ —Å—Ä–æ–∫ –∏—Å—Ç—ë–∫).
3. –ù–µ–ø–ª–∞—Ç–∏–≤—à–∏–µ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∏ —Ä–∞–∑—É –Ω–µ —Å–æ–≤–µ—Ä—à–∞–ª–∏ –æ–ø–ª–∞—Ç—É (`has_paid_ever = false`).

–û—Ç–±–æ—Ä ¬´–Ω–µ–ø–ª–∞—Ç–∏–≤—à–∏—Ö¬ª –∏–¥—ë—Ç –ø–æ —Ñ–ª–∞–≥—É, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º–æ–º—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —É—Å–ø–µ—à–Ω–æ–º webhook –ø–ª–∞—Ç–µ–∂–µ. –≠—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∏ –¥–µ—à–µ–≤–ª–µ, —á–µ–º –∞–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫/–ø–ª–∞—Ç–µ–∂–µ–π –∫–∞–∂–¥—ã–π —Ä–∞–∑.

---

## ÔøΩÔøΩüõ† –¢–∏–ø–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
–î–æ–±–∞–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ ‚Üí –∏–∑–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å / –¥–∞–Ω–Ω—ã–µ ‚Üí `revision --autogenerate` ‚Üí `upgrade`.
–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `requirements.txt` ‚Üí `docker compose build`.
–°–±—Ä–æ—Å–∏—Ç—å –ë–î (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ): `docker compose down -v`.

---

## üß™ Development vs Production
Dev –∑–∞–ø—É—Å–∫:
```bash
docker compose up --build
```
–õ–æ–≥–∏: `docker compose logs -f app`.

Production —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
* –ë–µ–∑ `watchfiles`
* Reverse proxy + TLS ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π DOMAIN
* Persistent idempotency —Ç–∞–±–ª–∏—Ü–∞
* –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤

–ü—Ä–∏–º–µ—Ä override:
```yaml
services:
	app:
		volumes:
			- ./:/app
		command: bash -c "alembic upgrade head && watchfiles --filter python 'python bot.py'"
```

---

## ‚ö†Ô∏è –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏
* UTC —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è; –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è
* DOMAIN –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ webhook
* –£–¥–∞–ª—ë–Ω–Ω—ã–π —Ç–∞—Ä–∏—Ñ ‚Üí –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —É–ø–∞–¥—ë—Ç (—Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å—é)
* –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É (rate limit Telegram)
* –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª –±–µ–∑ —É—á–∞—Å—Ç–∏—è –±–æ—Ç–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –Ω–µ—É—Å–ø–µ—à–Ω–æ–π

---

## ü©∫ Troubleshooting
| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|---------|
| 400 /yookassa | –ù–µ–≤–µ—Ä–Ω—ã–π webhook URL | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DOMAIN –∏ YooKassa –Ω–∞—Å—Ç—Ä–æ–π–∫—É |
| –ù–µ—Ç –ø—Ä–æ–¥–ª–µ–Ω–∏—è | –¢–∞—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Ç–∞—Ä–∏—Ñ–æ–≤ / –º–∏–≥—Ä–∞—Ü–∏–∏ |
| –î—É–±–ª–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–π | –ü–æ–≤—Ç–æ—Ä–Ω—ã–π webhook | –†–µ–∞–ª–∏–∑—É–π—Ç–µ persistent idempotency |
| –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É) | –í–∫–ª—é—á—ë–Ω channel_guard –∏ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –≤—Å–µ REQUIRED –∫–∞–Ω–∞–ª—ã | –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å / –æ—Ç–∫–ª—é—á–∏—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª–∏ |
| –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î | –ù–µ–≤–µ—Ä–Ω—ã–π URL / postgres –Ω–µ –ø–æ–¥–Ω—è—Ç | –õ–æ–≥–∏ postgres –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ |
| –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç | –ù–µ–≤–µ—Ä–Ω—ã–π BOT_TOKEN | –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω —É BotFather |


## –°–≤—è–∑—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º

–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ—Ä–∞–±–æ—Ç–∫–∏ / –≤–æ–ø—Ä–æ—Å—ã / –±–∞–≥–∏:

* Telegram: @ittadoru
