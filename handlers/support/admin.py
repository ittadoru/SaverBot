from aiogram import Router, F, types
from aiogram.types import Message
from utils.redis import r as redis
from config import SUPPORT_GROUP_ID
from utils.support_ticket import get_user_id_by_topic, get_ticket, close_ticket
from utils import logger as log
router = Router()

@router.message(F.chat.id == SUPPORT_GROUP_ID, F.is_topic_message)
async def admin_reply(message: Message):
    topic_id = message.message_thread_id
    user_id = await get_user_id_by_topic(redis, topic_id)
    if not user_id:
        return
    ticket = await get_ticket(redis, user_id)
    if not ticket or ticket["status"] != "open":
        await message.reply("–¢–∏–∫–µ—Ç —É–∂–µ –∑–∞–∫—Ä—ã—Ç.")
        return
    # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if message.text:
        await message.bot.send_message(
            user_id,
            f"üí¨ –û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏:\n{message.text}"
        )
    if message.photo:
        await message.bot.send_photo(
            user_id,
            message.photo[-1].file_id,
            caption=f"üí¨ –û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏:\n{message.caption or ''}"
        )
    log.log_message(f"üë®‚Äçüíª –ê–¥–º–∏–Ω –æ—Ç–≤–µ—Ç–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é id={user_id} –≤ —Ç–∏–∫–µ—Ç–µ topic_id={topic_id}: {message.text or '[–Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'}", emoji="üõ†Ô∏è")

    # –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏


@router.message(F.chat.id == SUPPORT_GROUP_ID, F.is_topic_message, F.text == "/stop")
async def admin_close_ticket(message: Message):
    topic_id = message.message_thread_id
    user_id = await get_user_id_by_topic(redis, topic_id)
    if not user_id:
        return
    ticket = await get_ticket(redis, user_id)
    if ticket and ticket["status"] == "open":
        await close_ticket(redis, user_id)
        await message.bot.send_message(
            user_id,
            "‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª –¥–∏–∞–ª–æ–≥. –ë–æ—Ç —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ."
        )
        await message.reply("–î–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∑–∞–∫—Ä—ã—Ç.")